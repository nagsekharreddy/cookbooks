{"options":[{"enabled":false,"definition":{"id":"5d58cc01-7c75-450c-be18-a388ddb129ec"},"inputs":{"branchFilters":"[\"+refs/heads/*\"]","additionalFields":"{}"}},{"enabled":false,"definition":{"id":"a9db38f9-9fdc-478c-b0f9-464221e58316"},"inputs":{"workItemType":"Issue","assignToRequestor":"true","additionalFields":"{}"}}],"triggers":[{"branchFilters":["+support/scalable"],"forks":{"enabled":true,"allowSecrets":true},"pathFilters":[],"requireCommentsForNonTeamMembersOnly":false,"isCommentRequiredForPullRequest":false,"triggerType":64}],"variables":{"CookbooksSource":{"value":"$(Build.Repository.LocalPath)\\cookbooks"},"ForceDeploy":{"value":"False"},"skipComponentGovernanceDetection":{"value":"true"},"system.debug":{"value":"false","allowOverride":true},"ttk.asset.filename":{"value":"AzTemplateToolKit.zip"},"ttk.folder":{"value":"$(Agent.BuildDirectory)\\test"}},"variableGroups":[{"variables":{"adminPassword":{"value":"Pcxuser@122robg"},"adminUsername":{"value":"PCXUSER2"},"certificateBase64Encoded":{"value":null,"isSecret":true},"certificatePassword":{"value":null,"isSecret":true},"databaseLogin":{"value":"testsrv-dp"},"databaseLoginPassword":{"value":null,"isSecret":true},"imageId":{"value":""},"imageReleaseState":{"value":"Production"},"lansaVersion":{"value":"V14 SP2"},"msiURL":{"value":"https://lansalpcmsdn.blob.core.windows.net/app/test/AWAMAPP_v14.2.20715_en-us.msi"},"osName":{"value":"Windows Server 2012"},"webPassword":{"value":null,"isSecret":true},"webUsername":{"value":"PCXUSER2"}},"type":"Vsts","name":"Template Parameters","description":"","id":3},{"variables":{"TestVersion-w12r2d-14-2":{"value":"10"},"TestVersion-w12r2d-15-0":{"value":"1"},"TestVersion-w16d-14-2":{"value":"1"},"TestVersion-w16d-15-0":{"value":"1"},"TestVersion-w19d-14-2":{"value":"1"},"TestVersion-w19d-15-0":{"value":"1"},"TestVersionPrev-w12r2d-14-2":{"value":"11"},"TestVersionPrev-w12r2d-15-0":{"value":"1"},"TestVersionPrev-w16d-15-0":{"value":"1"},"TestVersionPrev-w16d-14-2":{"value":"1"},"TestVersionPrev-w19d-14-2":{"value":"1"},"TestVersionPrev-w19d-15-0":{"value":"1"}},"type":"Vsts","name":"SKU Versions","description":"","id":1},{"variables":{"CookbooksBranch":{"value":"debug/paas"}},"type":"Vsts","name":"Default Branch","description":"Template Build uses the mentioned branch to fetch the Image Version Tests in the VMSS","id":5}],"properties":{},"tags":[],"_links":{"self":{"href":"https://dev.azure.com/VisualLansa/8b247587-8424-435c-9068-7e9fdd0edcf1/_apis/build/Definitions/5?revision=63"},"web":{"href":"https://dev.azure.com/VisualLansa/8b247587-8424-435c-9068-7e9fdd0edcf1/_build/definition?definitionId=5"},"editor":{"href":"https://dev.azure.com/VisualLansa/8b247587-8424-435c-9068-7e9fdd0edcf1/_build/designer?id=5&_a=edit-build-definition"},"badge":{"href":"https://dev.azure.com/VisualLansa/8b247587-8424-435c-9068-7e9fdd0edcf1/_apis/build/status/5"}},"jobAuthorizationScope":1,"jobTimeoutInMinutes":60,"jobCancelTimeoutInMinutes":5,"badgeEnabled":true,"process":{"phases":[{"steps":[{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Download TTK & Expand Files","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","versionSpec":"2.*","definitionType":"task"},"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"New-Item -Path $(ttk.folder) -ItemType Directory -verbose\nInvoke-WebRequest -Uri \"https://github.com/Azure/azure-quickstart-templates/releases/download/marketplace/AzTemplateToolKit.zip\" -OutFile \"$(ttk.folder)\\$(ttk.asset.filename)\" -verbose\n\n# Expand the TTK files\nGet-ChildItem \"$(ttk.folder)\" -Recurse\nWrite-Host \"Expanding files...\"\nExpand-Archive -Path \"$(ttk.folder)\\*.zip\" -DestinationPath \"$(ttk.folder)\" -Verbose\nWrite-Host \"Expanded files found:\"\nGet-ChildItem \"$(ttk.folder)\" -Recurse","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"true","workingDirectory":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Get Folder","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","versionSpec":"2.*","definitionType":"task"},"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# set this to a folder in the repo\n$fullpath = \"$env:BUILD_SOURCESDIRECTORY\\lansa-vmss-windows-autoscale-sql-database\"\n\nWrite-Host \"##vso[task.setvariable variable=sample.folder]$fullpath\"\n\n","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"true","workingDirectory":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Run Best Practice Tests","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","versionSpec":"2.*","definitionType":"task"},"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"Import-Module $(ttk.folder)/arm-ttk/arm-ttk.psd1 -Verbose\n$testOutput = @(Test-AzTemplate -TemplatePath \"$(sample.folder)\")\n\n$testOutput \n\nif ($testOutput | ? {$_.Errors }) {\n   exit 1 \n} else {\n   exit 0\n} \n","errorActionPreference":"stop","failOnStderr":"true","ignoreLASTEXITCODE":"false","pwsh":"true","workingDirectory":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Deploy ARM Template : BakingDP-TemplateTest","timeoutInMinutes":0,"condition":"or(succeeded(), eq(variables['ForceDeploy'], 'True'))","task":{"id":"94a74903-f93f-4075-884f-dc11f34058b4","versionSpec":"3.*","definitionType":"task"},"inputs":{"deploymentScope":"Resource Group","ConnectedServiceName":"e61ac796-c298-4e1f-a8dc-98fb50faa590","subscriptionName":"739c4e86-bd75-4910-8d6e-d7eb23ab94f3","action":"Create Or Update Resource Group","resourceGroupName":"BakingDP-TemplateTest-$(Build.BuildNumber)","location":"Australia East","templateLocation":"Linked artifact","csmFileLink":"","csmParametersFileLink":"","csmFile":"lansa-vmss-windows-autoscale-sql-database/mainTemplate.json","csmParametersFile":"","overrideParameters":"-osName \"Windows Server 2012\" -lansaVersion \"V14 SP2\" -msiURL \"https://lansalpcmsdn.blob.core.windows.net/app/test/AWAMAPP_v14.2.20715_en-us.msi\" -stackName \"build$(Build.BuildNumber)\" -certificateBase64Encoded \"$(certificateBase64Encoded)\" -certificatePassword \"$(certificatePassword)\" -databaseLogin \"$(databaseLogin)\" -databaseLoginPassword \"$(databaseLoginPassword)\" -adminUsername \"$(adminUsername)\" -adminPassword \"$(adminPassword)\" -webUsername \"$(webUsername)\" -webPassword \"$(webPassword)\"","deploymentMode":"Incremental","deploymentName":"TestTemplate","deploymentOutputs":"deploymentOutput","addSpnToEnvironment":"true"}},{"environment":{},"enabled":true,"continueOnError":true,"alwaysRun":false,"displayName":"Azure Resource Group Tagging","timeoutInMinutes":0,"condition":"always()","task":{"id":"567f7830-5655-4d11-b4c5-bada59a77796","versionSpec":"1.*","definitionType":"task"},"inputs":{"ConnectedServiceName":"e61ac796-c298-4e1f-a8dc-98fb50faa590","Action":"Add","ResourceGroupName":"BakingDP-TemplateTest-$(Build.BuildNumber)","Key":"Usage","Value":"test-temp"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Print Deployment Output","timeoutInMinutes":0,"condition":"or(succeeded(), eq(variables['ForceDeploy'], 'True'))","task":{"id":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","versionSpec":"2.*","definitionType":"task"},"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Print the Deployment Output\nWrite-Host \"$(deploymentOutput)\" | out-default | Write-Verbose","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Test ARM Deployment : URL Tests","timeoutInMinutes":0,"condition":"or(succeeded(), eq(variables['ForceDeploy'], 'True'))","task":{"id":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","versionSpec":"2.*","definitionType":"task"},"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Use the deployment output to extract the IpAddress\n$deploymentOutput=ConvertFrom-Json '$(deploymentOutput)'\n$IpAddress = $deploymentOutput.lbFqdn.value\n$url1 = \"$IpAddress/cgi-bin/probe\"\n$url2 = \"$IpAddress/cgi-bin/lansaweb?about\"\n$url3 = \"$IpAddress/cgi-bin/lansaweb?wam=DEPTABWA&webrtn=BuildFirst&ml=LANSA:XHTML&part=DEX&lang=ENG\"\n$url4 = \"$IpAddress/cgi-bin/lansaweb?wam=JSMLICE&webrtn=weblic&ml=LANSA:XHTML&part=DEX&lang=ENG\"\n$urls = @($url1, $url2, $url3, $url4)\nadd-type @\"\n    using System.Net;\n    using System.Security.Cryptography.X509Certificates;\n    public class TrustAllCertsPolicy : ICertificatePolicy {\n        public bool CheckValidationResult(\n            ServicePoint srvPoint, X509Certificate certificate,\n            WebRequest request, int certificateProblem) {\n            return true;\n        }\n    }\n\"@\n[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy\n$failureCount = 0\nforEach($url in $urls) {\n    try{\n        $response = Invoke-WebRequest -Uri $url -TimeoutSec 14\n        $ResponseCode = $response.StatusCode\n        if($ResponseCode -ne 200) {\n            Write-Host \"Response code not equal to 200: $ResponseCode\" | Out-Default | Write-Verbose\n            $failureCount = $failureCount + 1\n        } else {\n            Write-Host $ResponseCode | Out-Default | Write-Verbose\n        }\n    } catch {\n        Write-Host $_.Exception | Out-Default | Write-Verbose\n        $ResponseCode = $_.Exception.Response.StatusCode.Value__\n        $failureCount = $failureCount + 1\n        Write-Host $ResponseCode | Out-Default | Write-Verbose\n    }\n}\nif($failureCount) {\n    Write-Host \"Request failed for $($failureCount) URL(s)\"\n    throw \"The deployment failed the URL tests\"\n} else {\n    Write-Host \"Successfully tested all URL(s)\"\n}","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Azure PowerShell : Test Image Version w12r2d-14-2 Prod","timeoutInMinutes":0,"condition":"or(succeeded(), eq(variables['ForceDeploy'], 'True'))","task":{"id":"72a1931b-effb-4d2e-8fd8-f8472a07cb62","versionSpec":"5.*","definitionType":"task"},"inputs":{"ConnectedServiceNameARM":"e61ac796-c298-4e1f-a8dc-98fb50faa590","ScriptType":"InlineScript","ScriptPath":"","Inline":"Install-Module -Name Az.Compute -AllowClobber -Force\n$SkuName = \"w12r2d-14-2-$(TestVersion-w12r2d-14-2)\"\n\n$var=ConvertFrom-Json '$(deploymentOutput)'\n\n# Download TestImageVersion PS Script\nNew-Item -Path \"$(CookbooksSource)\\Tests\\Tests\" -ItemType Directory -verbose\nInvoke-WebRequest -Uri \"https://raw.githubusercontent.com/robe070/cookbooks/$(CookbooksBranch)/Tests/TestImageVersion.ps1\" -OutFile \"$(CookbooksSource)\\Tests\\TestImageVersion.ps1\" -verbose\n\n$vmssName = $var.scalesetName.value\nWrite-Host $vmssName | Out-Default\n\n # Execute the TestImageVersion PS Script\nWrite-Host \"Test the image version $SkuName by executing the script in the VMSS $vmssName\" | Out-Default | Write-Verbose\n$result = Invoke-AzVmssVMRunCommand -ResourceGroupName \"BakingDP-TemplateTest-$(Build.BuildNumber)\" -VMScaleSetName $vmssName -InstanceId '0' -CommandId 'RunPowerShellScript' -ScriptPath \"$(Build.Repository.LocalPath)\\cookbooks\\Tests\\TestImageVersion.ps1\" -Parameter @{ImgName = $SkuName}\n$result | Out-Default | Write-Host\nif ($result.Value[1].message -eq \"\") {\n    Write-Host \"Tested the image version in the VMSS successfully.\"\n} else {\n    throw $result.Value[1].message\n}","ScriptArguments":"","errorActionPreference":"stop","FailOnStandardError":"false","TargetAzurePs":"LatestVersion","CustomTargetAzurePs":"","pwsh":"false","workingDirectory":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Cleanup ARM Template : BakingDP-TemplateTest","timeoutInMinutes":0,"condition":"or(succeeded(), eq(variables['ForceDeploy'], 'True'))","task":{"id":"94a74903-f93f-4075-884f-dc11f34058b4","versionSpec":"3.*","definitionType":"task"},"inputs":{"deploymentScope":"Resource Group","ConnectedServiceName":"e61ac796-c298-4e1f-a8dc-98fb50faa590","subscriptionName":"739c4e86-bd75-4910-8d6e-d7eb23ab94f3","action":"DeleteRG","resourceGroupName":"BakingDP-TemplateTest-$(Build.BuildNumber)","location":"","templateLocation":"Linked artifact","csmFileLink":"","csmParametersFileLink":"","csmFile":"","csmParametersFile":"","overrideParameters":"","deploymentMode":"Incremental","deploymentName":"","deploymentOutputs":"","addSpnToEnvironment":"false"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Copy Files to: Artifact Staging Directory","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"5bfb729a-a7c8-4a78-a7c3-8d717bb7c13c","versionSpec":"2.*","definitionType":"task"},"inputs":{"SourceFolder":"lansa-vmss-windows-autoscale-sql-database","Contents":"*.json","TargetFolder":"$(build.artifactstagingdirectory)","CleanTargetFolder":"true","OverWrite":"true","flattenFolders":"false","preserveTimestamp":"false"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Archive Solution Template","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"d8b84976-e99a-4b86-b885-4849694435b0","versionSpec":"2.*","definitionType":"task"},"inputs":{"rootFolderOrFile":"$(build.artifactstagingdirectory)","includeRootFolder":"false","archiveType":"zip","sevenZipCompression":"5","tarCompression":"gz","archiveFile":"$(build.artifactstagingdirectory)/SolutionTemplate.zip","replaceExistingArchive":"true","verbose":"true","quiet":"false"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Copy Database Creation Files to: Artifact Staging Directory","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"5bfb729a-a7c8-4a78-a7c3-8d717bb7c13c","versionSpec":"2.*","definitionType":"task"},"inputs":{"SourceFolder":"lansa-vmss-windows-autoscale-sql-database","Contents":"DatabaseDeploymentTemplates/*.json","TargetFolder":"$(build.artifactstagingdirectory)","CleanTargetFolder":"false","OverWrite":"true","flattenFolders":"false","preserveTimestamp":"false"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Publish Artifact: Solution Template","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"2ff763a7-ce83-4e1f-bc89-0ae63477cebe","versionSpec":"1.*","definitionType":"task"},"inputs":{"PathtoPublish":"$(Build.ArtifactStagingDirectory)","ArtifactName":"Solution Template","ArtifactType":"Container","TargetPath":"","Parallel":"false","ParallelCount":"8","FileCopyOptions":""}}],"name":"Agent job: Template Tests","refName":"Job_1","condition":"succeeded()","target":{"executionOptions":{"type":0},"allowScriptsAuthAccessOption":false,"type":1},"jobAuthorizationScope":1}],"target":{"agentSpecification":{"identifier":"windows-2019"}},"type":1},"repository":{"properties":{"apiUrl":"https://api.github.com/repos/lansa/azure-quickstart-templates","branchesUrl":"https://api.github.com/repos/lansa/azure-quickstart-templates/branches","cloneUrl":"https://github.com/lansa/azure-quickstart-templates.git","connectedServiceId":"9d6d2af7-59b3-4a25-a732-193412ebf91c","defaultBranch":"support/scalable","fullName":"lansa/azure-quickstart-templates","hasAdminPermissions":"False","isFork":"True","isPrivate":"False","lastUpdated":"08/27/2020 08:20:12","manageUrl":"https://github.com/lansa/azure-quickstart-templates","nodeId":"MDEwOlJlcG9zaXRvcnk2NTk1NTY2Nw==","ownerId":"107727","orgName":"lansa","refsUrl":"https://api.github.com/repos/lansa/azure-quickstart-templates/git/refs","safeRepository":"lansa/azure-quickstart-templates","shortName":"azure-quickstart-templates","ownerAvatarUrl":"https://avatars1.githubusercontent.com/u/107727?v=4","archived":"False","externalId":"65955667","ownerIsAUser":"False","checkoutNestedSubmodules":"false","cleanOptions":"0","fetchDepth":"0","gitLfsSupport":"false","reportBuildStatus":"true","skipSyncSource":"false","labelSourcesFormat":"$(build.buildNumber)","labelSources":"0"},"id":"lansa/azure-quickstart-templates","type":"GitHub","name":"lansa/azure-quickstart-templates","url":"https://github.com/lansa/azure-quickstart-templates.git","defaultBranch":"support/scalable","clean":"false","checkoutSubmodules":false},"processParameters":{},"quality":1,"authoredBy":{"displayName":"Ashutosh Kumar","url":"https://spsprodeau1.vssps.visualstudio.com/A074edf4b-c1eb-403e-828d-96de9041e576/_apis/Identities/880010e2-da76-61f6-8f75-832ca079cfd4","_links":{"avatar":{"href":"https://dev.azure.com/VisualLansa/_apis/GraphProfile/MemberAvatars/aad.ODgwMDEwZTItZGE3Ni03MWY2LThmNzUtODMyY2EwNzljZmQ0"}},"id":"880010e2-da76-61f6-8f75-832ca079cfd4","uniqueName":"AshutoshKumar@lansacloudlansacom.onmicrosoft.com","imageUrl":"https://dev.azure.com/VisualLansa/_apis/GraphProfile/MemberAvatars/aad.ODgwMDEwZTItZGE3Ni03MWY2LThmNzUtODMyY2EwNzljZmQ0","descriptor":"aad.ODgwMDEwZTItZGE3Ni03MWY2LThmNzUtODMyY2EwNzljZmQ0"},"drafts":[],"queue":{"_links":{"self":{"href":"https://dev.azure.com/VisualLansa/_apis/build/Queues/9"}},"id":9,"name":"Azure Pipelines","url":"https://dev.azure.com/VisualLansa/_apis/build/Queues/9","pool":{"id":9,"name":"Azure Pipelines","isHosted":true}},"id":5,"name":"Lansa Templates - Azure Quick Start","url":"https://dev.azure.com/VisualLansa/8b247587-8424-435c-9068-7e9fdd0edcf1/_apis/build/Definitions/5?revision=63","uri":"vstfs:///Build/Definition/5","path":"\\","type":2,"queueStatus":0,"revision":63,"createdDate":"2020-08-29T04:11:59.310Z","project":{"id":"8b247587-8424-435c-9068-7e9fdd0edcf1","name":"Lansa Azure Scalable License Images","url":"https://dev.azure.com/VisualLansa/_apis/projects/8b247587-8424-435c-9068-7e9fdd0edcf1","state":1,"revision":13,"visibility":2,"lastUpdateTime":"2020-08-12T04:43:18.463Z"}}